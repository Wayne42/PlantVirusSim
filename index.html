<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
    <script src="math.js"></script>

  </head>
  <body>
    <div id="topnav">
    <nav class="topnav1">
      Simulation
    </nav>
    <nav class="topnav2">
      <button id="startstopbtn" onclick="startStop()">Start</button>   
      <label for="speed">
        <div>Speed: <span id="speedvalue">200</span>ms</div>
        <input type="range" id="speed" name="speed" min="50" max="10000" value="200" onChange="setSpeed(this)"/>
      </label>
      <label for="zoom">
        <div>Zoom: <span id="zoomvalue">1</span>x</div>
        <input type="range" id="zoom" name="zoom" min="1" max="5" value="1" onChange="setScale(this)"/>
      </label>
    </nav>
   </div>

    <div>
      <canvas id="canvas" width="4000" height="4000"> </canvas>
    </div>
    <div id="INFO"></div>

    <script>
      // parameters
      var _scale = 1; // canvas scale, useful for zoom
      var _speed = 50; // tick interval speed

      // panning vars
      var netPanningX = 0;
      var netPanningY = 0;

      // plant modelling
      var PlantsArray = [];

      var id = 0;

      function Plant(x, y, radius, wi = false, vi = false, li = false) {
        this.id = id++;
        this.XPos = x;
        this.YPos = y;
        this.radius = radius;

        // our binary data
        this.waterstress = wi;
        this.virusinfection = vi;
        this.lightstress = li;

        // wasserstand modelierung
        this.wasserStand = 50;
        this.wasserToleranz = 20; // plus minus so viel wasser ist ok für die pflanze und noch optimal
        this.optimalerWasserstand = 75; // so viel wasser liebt die pflanze und wächst perfekt

        this.wasserStressZeit = 0;
        // wenn eine Pflanze so lange wassergestresst ist, dann krepiert sie
        this.wasserStressZeitMax = 100;

        this.alive = true;

        this.virus = {};

        PlantsArray.push(this);

        this.initRandomStress = () => {
          this.waterstress = Math.random() > 0.5 ? false : true;
          this.virusinfection = Math.random() > 0.5 ? false : true;
          this.lightstress = Math.random() > 0.5 ? false : true;
        };

        // neighbors

        this.neighbors = { n: null, e: null, s: null, w: null }; // north, east, south, west

        this.getNearestNeighbors = () => {};

        this.render = () => {
          drawCircle(
            this.XPos + netPanningX,
            this.YPos + netPanningY,
            this.radius,
            this.alive ? "green" : "black",
            this.virusinfection ? "red" : "green"
          );
          drawRect(
            (this.XPos + this.radius / 2) + netPanningX,
            this.YPos + netPanningY,
            this.radius - 10,
            this.radius + 10,
            "white",
            "blue"
          );

          // waterlevel
          let wl = this.wasserStand / 100;
          drawRect(
            (this.XPos + this.radius / 2) + netPanningX,
            this.YPos + netPanningY,
            this.radius - 10,
            this.radius + 10,
            "blue",
            "blue"
          );
          writeMessage(this.id, this.XPos + netPanningX, this.YPos + netPanningY);
          writeMessage(
            this.wasserStand,
            (this.XPos + this.radius / 2) + netPanningX,
            this.YPos + 25 + netPanningY
          );
        };
      }

      
      // draw all plants
      function render(mode = "standard") {
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.save();
        context.scale(_scale, _scale);

        if (mode === "standard") {
          for (let i = 0; i < PlantsArray.length; i++) {
            PlantsArray[i].render();
          }
        }

        context.restore();
      }

      let time = 1;
      function nextTick() {
        // random regen oder so
        let rain = 0;
        if (randomNumber(1, 80) === 7) {
          rain = randomNumber(20, 100); // regenmenge
        }

        // events
        for (let i = 0; i < PlantsArray.length; i++) {
          if (randomNumber(1, 20000) === 7) {
            if (PlantsArray[i].virusinfection) {
              PlantsArray[i].alive = false;
            } else {
              PlantsArray[i].virusinfection = true;
            }
          }
          if (PlantsArray[i].virusinfection && PlantsArray[i].alive) {
            if (randomNumber(1, 100) === 7) {
              try {
                PlantsArray[i].neighbors.s.virusinfection = true;
              } catch (e) {}
            }
          }

          // wasserstress
          if (PlantsArray[i].alive) {
            PlantsArray[i].wasserStand -= 1;
          }
          // random regen oder so
          if (rain > 0) {
            PlantsArray[i].wasserStand += rain;
          }
          if (
            PlantsArray[i].wasserStand >
              PlantsArray[i].optimalerWasserstand +
                PlantsArray[i].wasserToleranz ||
            PlantsArray[i].wasserStand <
              PlantsArray[i].optimalerWasserstand +
                PlantsArray[i].wasserToleranz
          ) {
            PlantsArray[i].waterstress = true;
          } else {
            PlantsArray[i].waterstress = false;
          }
          if (PlantsArray[i].waterstress) {
            PlantsArray[i].wasserStressZeit++;
          }
          if (
            PlantsArray[i].wasserStressZeit > PlantsArray[i].wasserStressZeitMax
          ) {
            PlantsArray[i].alive = false;
          }
        }
        time++;
      }

      function renderNextTick() {
        nextTick();
        render();
      }

    </script>
    <script src="utility.js"></script>
    <script src="initFields.js"></script>
  </body>
</html>
